#!/bin/bash
ZIP_FILE="d440c514e54dd176bf6d006376cb119ce3f5d9aa85fbdf9559aaf601c53f94cb.zip"

# Create a Docker container from the image in a new terminal

gnome-terminal -- bash -c "
sudo docker run -it --name rasp-cont -p 2222:2222 --network malware_net --dns 10.0.0.4 dockerpi;
exec bash"

# Connect to the raspberry pi via ssh 

# Wait until the container is created
sleep 200;
rm -f ../.ssh/known_hosts
expect -c "
spawn ssh -p 2222 pi@localhost

# Type the password
expect {
    \"Are you sure*\" {send \"yes\r\"; exp_continue } 
     \"*password\" {send \"raspberry\r\"}
     timeout {puts \"Connection timed out\"; exit 1}
}
expect \"$\"
send \"mkdir Malware_analysis\r\"

# Wait until the files are tranferred to the raspberry pi 
send \"sleep 20\r\"
send \"cd Malware_analysis\r\"

# Unizp and change permissions of malware sample
send \"7z x "$ZIP_FILE" -p"infected"\r\"
send \"chmod +x d440c514e54dd176bf6d006376cb119ce3f5d9aa85fbdf9559aaf601c53f94cb.elf\r\"

# Run all files in the background 
send \"nohup python3 app.py > app.log 2>&1 & echo $! > app.pid\r\"
send \"nohup bash interaction_mal.sh > interaction.log 2>&1 & echo $! > interaction.pid\r\"
send \"nohup python3 feature_extraction.py execution_with_app_remnux_report.csv > feature_extraction.log 2>&1 & echo $! > feature_extraction.pid\r\"
send \"nohup ./d440c514e54dd176bf6d006376cb119ce3f5d9aa85fbdf9559aaf601c53f94cb.elf > d44.log 2>&1 & echo $! > d44.pid\r\"

# Wait in order to extract features and until the report.csv file gets transferred to the host 
send \"sleep 100\r\"

# Kill and Remove all processes
send \"kill $(cat app.pid)\r\"
send \"kill $(cat interaction.pid)\r\"
send \"kill $(cat feature_extraction.pid)\r\"

send \"rm app.pid\r\"
send \"rm interaction.pid\r\"
send \"rm feature_extraction.pid\r\"

send \"sleep 10\r\"

expect \"$\"

interact
"

#send \"exit\r\"

