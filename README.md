# Raspberry pi 3 Malware Analysis using QEMU 

This repository holds the files for performing Malware Analysis and feature extraction on a QEMU emulated raspberry pi 3 device created using Docker based on [this](https://github.com/lukechilds/dockerpi) Dockerfile. 
This Malware Analysis process and feature collection aims at facilitating the developement of a Machine Learning model for anomaly detection in raspberry pi devices (and other IoT devices) that will be deployed on the devices. 

Performance metrics are used as features for the Anomaly Detection model and are being extracted using [this](https://github.com/Nantina/performance_metrics_collection) script based on the psutil python module.  

## Process 
### Raspberry pi emulation
- The raspberry pi device is emulated using an image created with the Dockerfile that is included in this repository. 
- The Automation Scripts that are included in the  `automation_scripts` folder of this repository are being executed by the host in order to automate the whole procedure and avoid user interaction. 
### Benign Feature Extraction
- In order to simulate a normal behaviour of a raspberry pi and collect benign permormance metrics features, the app that is included in the `app_and_interaction` folder is being deployed in the device. Also the interaction script is used in order to make requests to the app and make even more realistic the rpi setup.
- These features will be used for the developement of a benign profile of the raspberry pi device for the Anomaly Detection model.  
### Malicious Feature Extraction
- For the malicious features that are going to be used in the testing phase of the Anomaly Detection model, Malware samples (Botnets, Ransomware and Backdoors) are injected into the emulated raspberry pi. 
- The same procedure as above is performed, though apart from the app, a malware sample is also being executed at a time. 
- A different interaction script is being used, for a simpler - more basic interaction with the app during the malware execution phase. 
- The same features are being extracted from the raspberry pi during this phase as above. 

## Dockerfile

In the current version of the Dockerfile the rapsberry pi vm image has been modified by installing the watchdog module in it.
This required a change in the Dockerfile as now the image is being copied from the same directory as the Dockerfile and not being downloaded as in the original version

## Automation Scripts

In order to automate the procesure of the malware samples execution, feature extraction and trasnfer of files back to the host two bash scripts have been implemented: 

- The `rpi_terminal.sh` script is responsible for handling the bash commands for the creation of the raspberry pi container, connecting to it via ssh and executing the files in it.
- The `host_terminal.sh` script is responsible for all the interactive commands that need to be executed by the host. Send files to the raspberry pi, receive files from the raspberry pi, remove docker containers and send files to the host via the shared folder functionality of Virtual Box. 
- The `automatic_feature_extraction.sh` script is responsible for running the two aforementioned scripts in parallel with the right timing in order to allow communication between the raspberry pi docker container and its host.

## Simple Flask Apps and Interaction 
Script contianing 3 simple Flask Apps that will be running in an emulated raspberry pi in order to simulate a normal/benign behaviour of a raspberry pi.

- The `app.py` file contains the three apps.
- The `interaction.sh` file contains requests that are repeated indefinitely in order to add some interaction with the apps. The requests are made in random intervals of 3 different levels of busyness, simulating a real app which handles different number of requests through a period.
- The `interaction_mal.sh` file contains simple requests that are repeated indefinitely in order to add the aforementioned interaction with the apps. This file is used during the execution of the malware samples and differs from the `interaction.sh` file in that it is simpler and only aims at simulating a basic service of a rasbperry pi. 
